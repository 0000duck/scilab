// =============================================================================
// Scilab ( http://www.scilab.org/ ) - This file is part of Scilab
// Copyright (C) 2008 - DIGITEO - Allan CORNET
//
//  This file is distributed under the same license as the Scilab package.
// =============================================================================
//Here with give a complete example on adding new primitive to Scilab
//create the procedure files
f1=['void c_sum(double *a,double *b, double *sum)'
    '{*sum=*a + *b;}'];
mputl(f1,'c_sum.c')
f2=['void c_sub(double *a,double *b, double *sub)'
    '{*sub=*a - *b;}'];
mputl(f2,'c_sub.c')
//creating the interface file
i=['#include ""stack-c.h""'
   'extern void c_sum(double *a,double *b, double *sum);'
   'int sci_csum(char *fname)'
   '{'
   '  int m1 = 0, n1 = 0, l1 = 0;'
   '  int m2 = 0, n2 = 0, l2 = 0;'
   '  int m3 = 0, n3 = 0, l3 = 0;'
   '  CheckRhs(1,2);'
   '  CheckLhs(1,1);'
   '  GetRhsVar(1, ""d"", &m1, &n1, &l1);'
   '  GetRhsVar(2, ""d"", &m2, &n2, &l2);'
   '  m3=1;n3=1;'
   '  CreateVar(Rhs+1,""d"",&m3,&n3,&l3);'
   '  c_sum(stk(l1),stk(l2),stk(l3));'
   '  LhsVar(1) = Rhs+1;'
   '  return 0;'
   '}'];
mputl(i,'sci_csum.c');
//creating the interface file
j=['#include ""stack-c.h""'
   'extern void c_sub(double *a,double *b, double *sum);'
   'int sci_csub(char *fname)'
   '{'
   '  int m1 = 0, n1 = 0, l1 = 0;'
   '  int m2 = 0, n2 = 0, l2 = 0;'
   '  int m3 = 0, n3 = 0, l3 = 0;'
   '  CheckRhs(1,2);'
   '  CheckLhs(1,1);'
   '  GetRhsVar(1, ""d"", &m1, &n1, &l1);'
   '  GetRhsVar(2, ""d"", &m2, &n2, &l2);'
   '  m3=1;n3=1;'
   '  CreateVar(Rhs+1,""d"",&m3,&n3,&l3);'
   '  c_sub(stk(l1),stk(l2),stk(l3));'
   '  LhsVar(1) = Rhs+1;'
   '  return 0;'
   '}'];
mputl(j,'sci_csub.c');
//creating the shared library (a gateway, a Makefile and a loader are
//generated.
files=['c_sub.c','sci_csub.c','c_sum.c','sci_csum.c'];
ilib_build('foo',['c_sum','sci_csum';'c_sub','sci_csub'],files,[]);
   Generate a gateway file
   Generate a loader file
   Generate a Makefile
   ilib_gen_Make: Copy compilation files (Makefile*, libtool...) to TMPDIR
   ilib_gen_Make: Copy c_sub.c to TMPDIR
   ilib_gen_Make: Copy sci_csub.c to TMPDIR
   ilib_gen_Make: Copy c_sum.c to TMPDIR
   ilib_gen_Make: Copy sci_csum.c to TMPDIR
   ilib_gen_Make: Copy libfoo.c to TMPDIR
   ilib_gen_Make: Modification of the Makefile in TMPDIR.
   Running the makefile
// load the shared library
exec loader.sce
 
// ------------------------------------------------------
 
// generated by builder.sce: Please do not edit this file
 
// ------------------------------------------------------
 
 
libfoo_path = get_file_path('loader.sce');
 
list_functions = [ 'c_sum';
            'c_sub';
];
 
addinter(libfoo_path+'/libfoo.so','libfoo',list_functions);
Shared archive loaded.
Link done.
 
// remove temp. variables on stack
 
clear libfoo_path;
 
clear list_functions;
 
clear get_file_path;
 
// ------------------------------------------------------
 
if c_sum(3,5) <> 8 then bugmes();quit;end
if c_sub(3,5) <> -2 then bugmes();quit;end
